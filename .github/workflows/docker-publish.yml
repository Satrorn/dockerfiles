name: 自动编译并上传镜像

# 设置触发条件
on:

  # 编辑文件触发开始编译
  push:
    paths:
      - 'Dockerfile'
  # 定时触发编译(每天早5点)
  schedule:
     - cron: '0 21 * * *'
  # 点☆Star触发开始编译
  watch:  
     types: [started]
     
 # 任务集
jobs:
  build:
    # 选择虚拟环境
    runs-on: ubuntu-latest
    
    # 自动编译单个镜像名称和版本(只设置一次)(PROJECT为必设)
    env:
      PROJECT: subweb
      TAGS: v1.0
    
    # 运行步骤
    steps:
      # 检出master分支
      - name: 出各个模块代码
        uses: actions/checkout@v3

      - name: 安装 QEMU
        uses: docker/setup-qemu-action@v2

      - name: 安装 docker buildx
        uses: docker/setup-buildx-action@v2

      - name: 获取日期
        id: tag
        # 项目自动和手动切换处
        run: |
          if [[ -n $(cat ${{ env.PROJECT }}/Dockerfile | awk '{if($1~"ENV" && $2=="VERSION")print $3}') ]]; then
            VERSION=$(cat ${{ env.PROJECT }}/Dockerfile | awk '{if($1~"ENV" && $2=="VERSION")print $3}')
            echo "tag=$VERSION" >> $GITHUB_ENV
          else
            echo "tag=$(date +%Y)$(date +%m)$(date +%d)" >> $GITHUB_ENV
          fi

      - name: 版本分类
        id: prepare
        # IMAGE_NAME ：镜像名称
        # ALI_ADD ：阿里镜像地址
        # TIME_VERSION ：日期版本
        # DOCKERHUB_VERSION ：镜像版本
        # TAG_VERSION ：标签版本
        # TAG_LATEST ： 最新版本
        # ALI_VERSION ：
        # ALI_LATEST ：
        # AUTO_UPDATE_TAG ：
        # AUTO_UPDATE_ALI ：
        # 项目自动和手动切换处
        run: |
          IMAGE_NAME=${{ env.PROJECT }}
          ALI_ADD=registry.cn-shenzhen.aliyuncs.com
          
          DOCKERHUB_VERSION=${{ env.TAGS }}
          TIME_VERSION=${{ env.tag }}

          TAG_VERSION="${{ secrets.DOCKERHUB_USERNAME }}/${IMAGE_NAME}:${DOCKERHUB_VERSION}"
          TAG_LATEST="${{ secrets.DOCKERHUB_USERNAME }}/${IMAGE_NAME}:latest"

          ALI_VERSION="${ALI_ADD}/${{ secrets.DOCKERHUB_USERNAME }}/${IMAGE_NAME}:${DOCKERHUB_VERSION}"
          ALI_LATEST="${ALI_ADD}/${{ secrets.DOCKERHUB_USERNAME }}/${IMAGE_NAME}:latest"

          AUTO_UPDATE_TAG="${{ secrets.DOCKERHUB_USERNAME }}/${IMAGE_NAME}:${TIME_VERSION}"
          AUTO_UPDATE_ALI="${ALI_ADD}/${{ secrets.DOCKERHUB_USERNAME }}/${IMAGE_NAME}:${TIME_VERSION}"

          echo "time_version=${TIME_VERSION}" >> $GITHUB_OUTPUT
          echo "dockerhub_version=${DOCKERHUB_VERSION}" >> $GITHUB_OUTPUT

          echo "tag_version=${TAG_VERSION}" >> $GITHUB_OUTPUT
          echo "tag_latest=${TAG_LATEST}" >> $GITHUB_OUTPUT

          echo "ali_version=${ALI_VERSION}" >> $GITHUB_OUTPUT
          echo "ali_latest=${ALI_LATEST}" >> $GITHUB_OUTPUT

          echo "auto_update_tag=${AUTO_UPDATE_TAG}" >> $GITHUB_OUTPUT
          echo "auto_update_ali=${AUTO_UPDATE_ALI}" >> $GITHUB_OUTPUT
          
      # 登录到DOCKERHUB
      - name: 登陆DOCKERHUB
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.PASSWORD }}

      # 登录到阿里镜像仓库
      - name: 登陆ALIYUN
        run: |
          docker login -u ${{ secrets.ALIYUN_USERNAME }} -p ${{ secrets.PASSWORD }} registry.cn-shenzhen.aliyuncs.com

      # 构建Amd64和Arm64的镜像
      - name: 构建和推送
        uses: docker/build-push-action@v3
        with:
          # 项目自动和手动切换处
          context: subweb
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ steps.prepare.outputs.tag_version }}
            ${{ steps.prepare.outputs.tag_latest }}
            ${{ steps.prepare.outputs.ali_version }}
            ${{ steps.prepare.outputs.ali_latest }}
            ${{ steps.prepare.outputs.auto_update_tag }}
            ${{ steps.prepare.outputs.auto_update_ali }}
            
      # 同步简介
      - name: README.md
        uses: ms-jpq/sync-dockerhub-readme@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.PASSWORD }}
          # 项目自动和手动切换处
          repository: ${{ secrets.DOCKERHUB_USERNAME }}/subweb
          # 项目自动和手动切换处
          readme: "subweb/README.md"

      # 删除旧的工作流
      - name: Del
        uses: Mattraks/delete-workflow-runs@main
        with:
          repository: ${{ github.repository }}
          retain_days: 1
          # 保留多少个workflow不删除
          keep_minimum_runs: 1
